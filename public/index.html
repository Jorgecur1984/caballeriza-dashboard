<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kiosco de Salas – Caballeriza</title>
  <style>
    :root{
      --ok:#22c55e; --busy:#ef4444; --warn:#f59e0b;
      --bg:#0b1020; --card:#11162a; --card2:#0e1428; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa;
      --card-h:clamp(180px,26vh,220px);
      --radius-lg:16px;
    }

    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
      overflow:hidden;
    }

    #stageOuter{
      position:fixed;inset:0;display:flex;align-items:stretch;justify-content:center;
      background:var(--bg);overflow:hidden;
    }
    #stage{
      width:100vw;height:100vh;
      display:flex;flex-direction:column;gap:16px;padding:16px;box-sizing:border-box;
    }

    header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:clamp(18px,3.2vw,28px);margin:0;font-weight:800}
    .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#172033;border:1px solid #233054}
    .dot{width:10px;height:10px;border-radius:999px}
    .dot.ok{background:var(--ok)} .dot.busy{background:var(--busy)} .dot.warn{background:var(--warn)}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button,select,input[type="date"]{
      background:#172033;color:var(--text);border:1px solid #233054;border-radius:10px;
      padding:8px 12px;cursor:pointer;font-size:14px
    }
    button:hover{filter:brightness(1.08)}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:14px;flex:1;overflow:auto;padding-bottom:12px;
    }

    .card{
      position:relative;display:flex;flex-direction:column;gap:8px;
      background:linear-gradient(180deg,var(--card),var(--card2)60%);
      border:1px solid #1c2442;border-radius:var(--radius-lg);
      padding:14px;padding-top:52px;height:var(--card-h);
      box-shadow:0 6px 18px rgba(0,0,0,.2);
      transition:transform .15s,box-shadow .15s,border-color .15s;
      overflow:hidden;
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(0,0,0,.28);border-color:#2a3a6b}
    .statusBar{position:absolute;inset:auto 0 0 0;height:6px}
    .status-ok{background:var(--ok)} .status-busy{background:var(--busy)} .status-warn{background:var(--warn)} .status-info{background:var(--accent)}

    .busy-badge{
      position:absolute;top:10px;right:10px;padding:6px 10px;border-radius:999px;
      background:#172033;font-size:12px;border:1px solid #233054;z-index:2;white-space:nowrap;color:#cdd6e5
    }

    .room-name{font-size:18px;font-weight:800;padding-right:120px}
    .location{font-size:12px;color:var(--muted)}
    .time{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .agenda{margin-top:4px;font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:3px;max-height:72px;overflow:auto}
    .agenda::-webkit-scrollbar-thumb{background:#2a3556;border-radius:8px}
    .meta{margin-top:auto;display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .meta b{color:var(--text)}

    footer{display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;color:var(--muted);font-size:13px}

    .modal{position:absolute;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:10000}
    .modal.open{display:flex}
    .sheet{background:#0b1228;border:1px solid #1c2442;color:var(--text);border-radius:16px;width:min(720px,96%);padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .sheet h3{margin:0 0 6px;font-weight:800}
    .sheet .sub{color:var(--muted);font-size:13px}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:8px;margin-top:10px;font-size:14px}
    .actions{display:flex;justify-content:flex-end;margin-top:14px}

    @media(max-width:420px){
      .grid{grid-template-columns:1fr}
      .kv{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div id="stageOuter">
    <div id="stage">
      <header>
        <div class="brand">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3l9 4.5v9L12 21 3 16.5v-9L12 3z" stroke="#60a5fa" stroke-width="1.5"/></svg>
          <h1>Salas – Caballeriza</h1>
          <div class="legend">
            <span class="tag"><span class="dot ok"></span> Disponible</span>
            <span class="tag"><span class="dot busy"></span> Reservada</span>
            <span class="tag"><span class="dot warn"></span> Próx. reunión</span>
          </div>
        </div>
        <div class="controls">
          <select id="locationFilter"><option value="">Todos los pisos</option></select>
          <button id="todayBtn">Hoy</button>
          <button id="tomorrowBtn">Mañana</button>
          <input type="date" id="datePicker" />
          <button id="refreshBtn">Actualizar</button>
          <button id="fullscreenBtn">Pantalla completa</button>
        </div>
      </header>

      <section class="grid" id="grid"></section>

      <footer>
        <div>Última actualización: <span id="lastUpdated">—</span></div>
        <div>Fecha vista: <span id="viewDateLabel">—</span> | Reloj: <span id="clock">—</span> | Auto-refresh: <span id="intervalLabel">60s</span></div>
      </footer>

      <div class="modal" id="modal">
        <div class="sheet">
          <h3 id="mRoom">Sala</h3>
          <div class="sub" id="mStatusLine">—</div>
          <div class="kv">
            <div><b>Ubicación</b></div><div id="mLocation">—</div>
            <div><b>Capacidad</b></div><div id="mCapacity">—</div>
            <div><b>Reunión</b></div><div id="mTitle">—</div>
            <div><b>Horario</b></div><div id="mTime">—</div>
            <div><b>Asistentes</b></div><div id="mAttendees">—</div>
            <div><b>Organizador</b></div><div id="mOrganizer">—</div>
            <div><b>Notas</b></div><div id="mNotes">—</div>
            <div><b>Actualizado</b></div><div id="mUpdated">—</div>
          </div>
          <h4>Reservas del <span id="mDayLabel">—</span></h4>
          <div id="mDayList"></div>
          <div class="actions"><button id="closeModal">Cerrar</button></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PROXY_URL='/api/escritoir/dashboard';
    const AUTO_REFRESH_MS=60000;
    const grid=document.getElementById('grid');
    const clockEl=document.getElementById('clock');
    const lastUpdatedEl=document.getElementById('lastUpdated');
    const intervalLabel=document.getElementById('intervalLabel');
    const locationFilter=document.getElementById('locationFilter');
    const datePicker=document.getElementById('datePicker');
    const viewDateLabel=document.getElementById('viewDateLabel');
    const todayBtn=document.getElementById('todayBtn');
    const tomorrowBtn=document.getElementById('tomorrowBtn');
    const TODAY=startOfDay(new Date());
    let VIEW_DATE=startOfDay(new Date());
    let ROOMS=[];

    function startOfDay(d){const x=new Date(d);x.setHours(0,0,0,0);return x;}
    function ymd(d){const x=new Date(d);return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;}
    function escapeHtml(s=''){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

    async function fetchData(){
      const dateStr=ymd(VIEW_DATE);
      const url=`${PROXY_URL}?date=${dateStr}`;
      const res=await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error('API error '+res.status);
      return adaptEscritoir(await res.json());
    }

    function adaptEscritoir(payload){
      if(!Array.isArray(payload))return[];
      const items=[];
      for(const r of payload){
        const area=r?.area||{};
        const roomName=asText(area?.name)||'(sin sala)';
        const capacity=Number(area?.max_occupancy||0);
        const location=deriveLocationFromName(roomName);
        const schedules=Array.isArray(r?.schedules)?r.schedules:[];
        if(!schedules.length){
          items.push({room_name:roomName,location,capacity,start:null,end:null,title:'',organizer:'',active:true});
        }else for(const s of schedules){
          items.push({room_name:roomName,location,capacity,
            start:parseApiDate(s?.initial_date||s?.start),
            end:parseApiDate(s?.end_date||s?.end),
            title:asText(s?.title||''),organizer:asText(s?.user?.name||s?.organizer||''),active:true});
        }
      }
      return aggregateReservations(items);
    }

    function asText(v){if(v==null)return'';if(typeof v==='string'||typeof v==='number')return String(v);if(Array.isArray(v))return v.map(asText).filter(Boolean).join(', ');if(typeof v==='object'){if('name'in v)return asText(v.name);if('title'in v)return asText(v.title);}return'';}
    function deriveLocationFromName(name){const m=/piso\s*([0-9]+)/i.exec(String(name||''));return m?`Piso ${m[1]}`:'';}
    function parseApiDate(v){if(!v)return null;const t=Date.parse(String(v).trim());return Number.isNaN(t)?null:new Date(t);}
    function countEmails(s){return s?s.split(',').filter(x=>x.trim()).length:0;}
    function hashCode(str){let h=0;for(let i=0;i<str.length;i++){h=(h<<5)-h+str.charCodeAt(i)|0;}return Math.abs(h);}

    function aggregateReservations(items){
      const now=Date.now(),byRoom=new Map();
      for(const it of items){
        if(!it.active)continue;
        const key=it.room_name||'(sin sala)';
        if(!byRoom.has(key))byRoom.set(key,{room_id:hashCode(key),room_name:key,location:it.location||'',capacity:+it.capacity||0,status:'Available',all_slots:[]});
        const r=byRoom.get(key);
        if(it.start)r.all_slots.push({start:it.start.toISOString(),end:it.end?.toISOString()||'',title:it.title||'',ymd:ymd(it.start),organizer:it.organizer||''});
        const inProgress=it.start&&it.end&&(it.start.getTime()<=now&&now<=it.end.getTime());
        const soon=it.start&&it.start.getTime()>now&&(it.start.getTime()-now)<=1800000;
        if(inProgress){r.status='Reserved';r.start_time=it.start;r.end_time=it.end;}
        else if(soon&&r.status!=='Reserved'){r.status='Soon';r.start_time=it.start;r.end_time=it.end;}
      }
      return Array.from(byRoom.values());
    }

    function render(){
      const frag=document.createDocumentFragment();
      ROOMS.forEach(r=>{
        const card=document.createElement('article');card.className='card';
        const name=el('div','room-name',r.room_name);
        const loc=el('div','location',r.location);
        const badge=el('div','busy-badge',r.status==='Reserved'?'Reservada':r.status==='Soon'?'Próx. reunión':'Libre');
        const bar=el('div','statusBar '+(r.status==='Reserved'?'status-busy':r.status==='Soon'?'status-warn':'status-ok'));
        card.append(bar,badge,name,loc);
        card.addEventListener('click',()=>alert(r.room_name));
        frag.append(card);
      });
      grid.replaceChildren(frag);
      lastUpdatedEl.textContent=new Date().toLocaleTimeString();
    }

    const el=(t,c,txt)=>{const e=document.createElement(t);if(c)e.className=c;if(txt)e.textContent=txt;return e;}

    async function loadAndRender(){try{ROOMS=await fetchData();render();}catch(e){console.error(e);}}

    datePicker.value=ymd(VIEW_DATE);
    setInterval(()=>clockEl.textContent=new Date().toLocaleTimeString(),1000);
    intervalLabel.textContent=String(AUTO_REFRESH_MS/1000)+'s';
    loadAndRender();setInterval(loadAndRender,AUTO_REFRESH_MS);
  </script>
</body>
</html>

